//raw[|latex| \\clearpage ]


ビルド
------

### arduino-builder

Arduino1.6.6以降、スケッチのビルドは`arudino-builder` のコマンドに
委譲して行われる。

この、arduino-builderはarduinoのビルド設定である`platform.txt`の
設定からコンパイル、リンクのコマンドライン引数を決定して、ビルドを行う機能を持つ。
従来、IDEで抱えていた機能を単体プログラムに分離したものでもあり、
コマンドラインからでもスケッチのビルドが可能となった。

#### arduino-buidlerによるビルドの流れ

arduino-builderによるビルドは以下のような手順で行われる。

: ライブラリのスキャン
  ソースを解析して、依存しているライブラリを探索する。

: スケッチのコンパイル
  .inoのスケッチファイルを C++ に変換して、コンパイルする。

: ライブラリのコンパイル
  依存関係が見つかったライブラリをコンパイルする。

: coreのコンパイル
  arduinoのフレームワークのソースをコンパイルする。
  コンパイルして出来た.oのファイルを集めて.aのスタティックライブラリを作る。

: リンク
  コンパイルしたスケッチ、ライブラリ、coreをリンクして
  バイナリを生成する

: hex化
  マイコンに書き込める形式に変換が必要な場合は変換ツールを呼び出して、書き込み可能な形式に変換する。

: サイズ確認
  コードの使用量を表示し、必要であれば警告を表示する

ライブラリのスキャンは実はかなりの力技である。
これは、インクルードが解決するまで、ライブラリのフォルダを
*エラーメッセージを解析して* 不足しているフォルダを
片っ端からインクルード対象にして探し回る。
所謂総当たり方式で検索を行っている。


### Contikiのビルドシステム

Contikiのビルドシステムは既に紹介したように、
Makefileをベースに作られている。
arduino-builderはarduinoの管理下のソースのビルドに特化しているため、
Contikiの部分のビルドには使えない、Contikiのビルドシステムで
Arduino部分のソースをビルドする必要がある。

arduinoとしてビルド対象となるファイルはarduino-builderが知っているが、
これを何らかの方法でMakefileに反映する必要がある。

### contiki-makehelper

この目的のために、arduino-builderから実行されるコンパイル実行の情報を
収集する、contiki-makehelperを導入する。
arduino-builderの処理からは、リンクの処理までのコマンドライン情報が
集まれば、Makefileを生成に必要な情報は集まる。

arduino-builderの動作を決めているplatform.txtを変更し、
コンパイラのツールチェーンの各ツールの代わりにこのツールを起動する。

コマンドの実行毎にコマンドラインで渡される、arduino-builderが決定したパラメータを
ファイルに書き出して、情報を収集する。
arduino-builderがhex化の指示を出すのに合わせて、
それまで収集した情報を元にMakefileを作成、makeの実行を行う。

Arduino IDEの動作に合わせて、ファイルの生成先のディレクトリが
多少変則的にはなるものの、この手法でcontikiのビルドシステムを
ArduinoのIDEから起動できるようになった。
